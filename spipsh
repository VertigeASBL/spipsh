#!/bin/bash

# Boîte à outils SPIP pour la ligne de commande.

# Complète spip-cli, en ce s'occupant des choses hors de sa portée, comme les
# permissions sur les dossiers.

# TODO vérifier que l'on est bien à la racine d'un spip, et afficher un message
#      d'erreur sinon.

# TODO dans l'idéal le script devrait aussi fonctionner quand on est dans un
#      sous-répertoire d'un spip. Il faudrait alors calculer le chemin de la
#      racine, puis l'utiliser à la place des (pwd) qu'on utilise actuellement.

SPIP_DIRECTORIES="config IMG local lib tmp plugins plugins/auto plugins/fabrique_auto squelettes"

case $1 in
    init)
        for dir in $SPIP_DIRECTORIES
        do
            if [[ ! -d $dir ]]
            then
                echo "crée le dossier $dir";
                mkdir $dir;
            fi
        done
        echo "répare les permissions";
        chmod a+rwX $SPIP_DIRECTORIES ;;
    cc)
        echo "vide le cache";
        ls -d tmp/* | grep -E "tmp/.*cache" | xargs rm -rf;

        if [[ $2 == "all" ]] ; then
            echo "vide le cache des vignettes";
            rm -rf local/*
        fi ;;
    *)
        echo "Contrôle SPIP à la ligne de commande. Doit être executé
depuis la racine d'un site spip.

Usage : spipsh [COMMAND]

Commandes admises :
  cc         Vide les caches du dossier tmp, à la dure, sans passer par SPIP
  cc all     Vide les caches du dossier tmp, ainsi que le dossier
               local.
  init       Crée les dossiers de plugins et de libraires, puis
               donne les permissions adequates.
" ;;
esac
